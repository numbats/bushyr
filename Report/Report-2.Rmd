---
title: "Report-2"
author: "Helen Evangelina"
date: "02/11/2021"
output: html_document
---


```{r setup, echo=FALSE, message = FALSE, warning= FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(readr)
library(sp)
library(mapview)
library(rgdal)
library(raster)
library(DT)
library(lubridate)
library(forcats)
library(purrr)
library(sf)
```


# Introduction and Motivation

Bushfire is an intrinsic part of Australia’s environment (https://www.ga.gov.au/scientific-topics/community-safety/bushfire) and it has been a massive issue in Australia as it has caused significant damages in property, life as well as the nature. There have been some catastrophic bushfire events in the past including Black Saturday 2009 in Victoria, Ash Wednesday 1983 in Victoria and South Australia, the 2006 December bushfires, as well as the recent 2019-2020 bushfires. Canada, USA, Turkey, Greece, Italy and Russia faced a devastating bushfire season in the summer of 2021 since it was the hottest July ever recorded, raising concern for Australia since it is moving into summer. Especially since the 2019-2020 bushfire in Australia resulted to more damages on property and the environment compared to other bushfire events in history, with 3094 houses destroyed and over 17M hectares of land burned (Lisa Richards, Nigel Brew and Smith, 2020). 

Even though bushfires cannot be avoided naturally, their consequences can be minimised. Thus, it is important to predict the risk of bushfire as understanding the risk of fire of certain areas would help in developing strategies for mitigating the risks. A prediction model can tell us whether an area has a high risk of bushfire, and we can focus on areas with high fire risk. We will use certain modeling methods to come up with the most suitable model for predicting the bushfire risk. 

This work will focus on Victoria. It is based on Weihao Li’s thesis titled “Using Remote Sensing Data to Understand Fire Ignitions in Victoria during the 2019-2020 Australian Bushfire Season” (citation). Weather is considered a determinant for forest fires (Brown et al. 2008). Therefore, we will be using environmental variables such as temperature, relative humidity, wind speed, radiation, drought index, etc in our modelling as the predictors. We will be testing if these variables are significant for predicting the risk of bushfire in Victoria. 

Fire risk is defined as the likelihood of a fire occurring, multiplied by the severity of the fire (https://www.merton.gov.uk/assets/Documents/www2/fire_safety_risk_assessment_-_june_2013.pdf). However, in this case, we will be defining fire risk as only the likelihood of fire occurring. 
The overall objectives of this work are to develop a web app by using shiny to monitor potential fire ignitions by developing fire risk models for the 2021-2022 Victorian bushfire season based on environmental variables in where users would be able to input the values of the environmental variables which would change the risk predictions. 

# Data
## Data Sources
The data used for this project is the satellite hotspots data, which is collated with environmental variables data from ERA5, as well as forest data, and roads data (?).

### First respondent fire data (historical fire data)
We use the historical bushfire ignition locations and causes from the Victorian Department of Environment, Land, Water and Planning (DELWP) Fire Origins and compare it with the hotspot data from Himawari-8 to see which data is more accurate to be used in our modelling. This dataset provides the locations and causes of historical bushfire ignitions reported by the first respondent. These locations are recorded by crews rather than the exact origin of fire. 

### Satellite data 
Hotspot data from Himawari-8 satellite (P-Tree System, 2020) provides a high temporal and spatial resolution. This data can be taken from the Japan Aerospace Exploration Agency FTP site. Himawari-8 data is a remote sensing data which are collected by remote sensors carried by a satellite. The reason we compare the Himawari-8 satellite data with the historical bushfire data is that there are some bushfires start in very remote areas which are virtually impossible to access. Remote sensing data provides a possible solution for this, and it may provide a more accurate locations of bushfire ignitions. Himawari-8 data has a 10-minute time resolution. 

### ERA5 weather data

### Fuel layer
The fuel layer data is obtained from the 2018 nationwide forest dataset from Australian Bureau of Agricultural and Resource Economics and Services (2018). This data consists of a continental spatial dataset of forest extent by national forest categories and types. A forest variable is used as a predictor in our model in where 0 indicates that the grid cell is not a forest and 1 if otherwise.

## Data processing
### Himawari-8 hotspot data
The hotspot data from Himawari-8 firstly needs to be selected to those within the boundary of Victoria. To reduce noise, it is then filtered based on the fire power with a recommended threshold of over 100 (irradiance over 100 watts per square metre) (Williamson, 2020). 
The hotspot data from Himawari-8 needs to be grouped into clusters because some hotspots are branches of an existing bushfire. Therefore, we use spatio-temporal clustering to group the hotspots into clusters. Clustering algorithm used in this project is based on Weihao Li’s thesis (citation & reference), inspired by two existing clustering algorithm, Density Based Spatial Clustering of Applications with Noise (DBSCAN) (Ester et al., 1996) and Fire Spread Reconstruction (FSR) (Loboda and Csiszar, 2007). 
The issue with using DBSCAN for clustering hotspot data is its algorithm assumes the clustering rules work in both directions of a timeline, which does not capture the reality that bushfires evolve over time in one direction. It is not suitable for temporal data. FSR reconstructs bushfire spread well, however it is constructing the clusters sequentially. This means that FSR will consider two fires to be a single fire if they commence at different locations but they overlap. Because of this, FSR does not reflect the real speed of bushfire correctly. Other limitation of FSR is that it lacks detailed consideration of parameter tuning. Weihao Li’s clustering algorithm is inspired by these two algorithms, and it can efficiently and robustly cluster hotspot to consider the temporal behavior of bushfires.
There are four steps in the clustering algorithm. The first step is to slice the temporal dimension based on a parameter named ActiveTime. Next, the hotspots are clustered spatially by using a parameter called AjdDist, which reflects the potential distance a fire can spread with respect to the temporal resolution of the data. Hotspots in the same component will be assigned a unique membership id. The third step is to broadcast the clustering results and update the membership label. Lastly, the ignition locations are computed with the earliest observed hotspot indicates the ignition point. If there are several earliest hotspots, the centroid of these points is used. 
The clustering algorithm slices the data by its temporal dimension and splits the spatio-temporal clustering tasks into thousands spatial clustering tasks. The result of the clustering is a dataset consisting of four variables – unique identifier, longitude, latitude, and time. The final hotspot data used for this project consists of 2,917 observations from 2016 to 2021. 

### ERA5 data

## Data integration
-- Talks about lagged variables bcs this might be important. The risk of fire happening might be affected by the average weather conditions for the two months or even a year. A hotter and drier year might result to more fires than --



```{r, echo = FALSE}
training <- read.csv(here::here("VICfire/data/training.csv"))
  
  training <- training %>%
    filter(!CAUSE %in% c("BURNING BUILDING",
                         "WASTE DISPOSAL, INDUSTRIAL, SAWMILL, TIP",
                         "WASTE DISPOSAL, DOMESTIC",
                         "BURNING VEHICLE, MACHINE",
                         "BURNING BUILDING")) %>%
    filter(new_cause != "other") %>%
    filter(new_cause != "relight")
  
  
  training <- dplyr::select(training, -c(EVENTID:FIRE_NUM), -id, -CAUSE, -FOREST, -FOR_CODE, -FOR_CAT)
  
  training <- mutate(training,
                     year = factor(year(FIRE_START)),
                     month = factor(month(FIRE_START), levels = c(10,11,12,1,2,3)),
                     day = factor(day(FIRE_START), levels = c(1:31)),
                     wod = factor(wday(FIRE_START), levels = c(1:7)))
  
  training <- filter(training, month %in% c(10,11,12,1,2,3))
  
  training <- na.omit(training)
  
  training <- mutate(training, new_cause = ifelse(new_cause == "accidental_human", "accident", new_cause)) %>%
    mutate(new_cause = ifelse(new_cause == "burning_off_human", "burning_off", new_cause)) %>%
    mutate(new_cause = factor(new_cause)) %>%
    mutate(FOR_TYPE = factor(FOR_TYPE))
  
  training <- na.omit(training)
  
  training <- mutate(training,
                     log_dist_cfa = log(dist_cfa),
                     log_dist_camp = log(dist_camp),
                     log_dist_road = log(dist_road),
                     COVER = factor(COVER),
                     HEIGHT = factor(HEIGHT))
  
  training <- rename(training, cause = new_cause)
  training <- mutate(training,
                     cause = fct_relevel(cause,
                                         "lightning",
                                         "accident",
                                         "arson",
                                         "burning_off"))
  
  training <- na.omit(training)
  
  training <- dplyr::select(training, -dist_road, -dist_cfa, -dist_camp, -FIRE_START)
```

```{r, echo = FALSE}
training2016 <- training %>%
  filter((year == 2016 & month %in% c(10,11,12)) | (year == 2017 & month %in% c(1,2,3)))

training2017 <- training %>%
  filter((year == 2017 & month %in% c(10,11,12)) | (year == 2018 & month %in% c(1,2,3)))
```

# Comparison of Hotspot and Historical Fire Data
As previously stated, historical fire data might not represent the accurate locations of the bushfire ignitions. Fire might start in a remote location which might be hard to visually access or monitor. Therefore, to choose which fire data to use for our modelling, we do comparisons on the historical fire data and the satellite data. The satellite data used here is the clustered satellite data.
```{r, echo = FALSE}
# loading the clustered data
hotspot2016_2018 <- read.csv(here::here("VICfire/data/clustering/predict_x_2016_2018.csv"))
hotspot2019_2020 <- read.csv(here::here("VICfire/data/clustering/predict_x_2019_2020.csv"))

hotspot2016_2018 <- hotspot2016_2018 %>%
  mutate(year = year(time),
         month = month(time))

hotspot2019_2020 <- hotspot2019_2020 %>%
  mutate(year = year(time),
         month = month(time))

hotspot2016 <- hotspot2016_2018 %>%
  filter((year == 2016 & month %in% c(10,11,12)) | (year == 2017 & month %in% c(1,2,3)))

hotspot2017 <- hotspot2016_2018 %>%
  filter((year == 2017 & month %in% c(10,11,12)) | (year == 2018 & month %in% c(1,2,3)))

hotspot2018 <- hotspot2016_2018 %>%
  filter((year == 2018 & month %in% c(10,11,12)) | (year == 2019 & month %in% c(1,2,3)))

hotspot2019 <- hotspot2019_2020 %>%
  filter((year == 2019 & month %in% c(10,11,12)) | (year == 2020 & month %in% c(1,2,3)))

hotspot2020 <- hotspot2019_2020 %>%
  filter((year == 2020 & month %in% c(10,11,12)) | (year == 2021 & month %in% c(1,2,3)))
```

```{r, echo = FALSE}
training2017_selected <- training2017 %>%
  dplyr::select(lon, lat, year, month) %>%
  mutate(type = "training")

hotspot2017_2 <- hotspot2017 %>%
  dplyr::select(-id, -time) %>%
  mutate(type = "hotspot")

# converting to factor
hotspot2017_2$year <- as.factor(hotspot2017_2$year)
hotspot2017_2$month <- as.factor(hotspot2017_2$month)

joined_2017 <- training2017_selected %>%
  bind_rows(hotspot2017_2)
```

```{r}
training2016 <- training2016 %>%
  mutate(period = "2016-2017")

training2017 <- training2017 %>%
  mutate(period = "2017-2018")

hotspot2016 <- hotspot2016 %>%
  mutate(period = "2016-2017")

hotspot2017 <- hotspot2017 %>%
  mutate(period = "2017-2018")

training2016_2017 <- training2016 %>%
  bind_rows(training2017) %>%
  dplyr::select(lon, lat, year, month, period) %>%
  mutate(type = "training")

hotspot2016_2017 <- hotspot2016 %>%
  bind_rows(hotspot2017) %>%
  mutate(type = "hotspot")

# converting to factor
hotspot2016_2017$year <- as.factor(hotspot2016_2017$year)
hotspot2016_2017$month <- as.factor(hotspot2016_2017$month)

joined_all <- training2016_2017 %>%
  bind_rows(hotspot2016_2017)
```

```{r}
#comparing distribution
joined_all %>%
  count(month,year, type, period) %>%
  group_by(type, year, period) %>%
  ggplot(aes(x = month,
             y = n)) +
  geom_bar(aes(fill = type), position = "dodge", stat = "identity") +
  ggtitle("Comparison of historical vs satellite data") +
  facet_grid(~period) +
  ylab("Number of fires")
```

The above plot illustrates the comparison of the number of fires from the satellite data and the historical fire data for the period 2016-2017 and 2017-2018. There are more hotspot data for the period of 2016-2017 in January, February and March, and more historical data for October, November, and December. Meanwhile for period 2017-2018, the historical dataset has more observations overall except for March. One obvious insight here is that the number of observations is not consistent monthly, indicating that month is an important factor in determining the risk of fire. The number of bushfires in November and December from the satellite data is significantly lower compared to the historical data, which might be due to the filtering of fire power to only include big fires. 

```{r}
# traaining data
training2017_2 <- training2017
coordinates(training2017_2) = c("lon", "lat")

x1 <- raster(xmn = 141,
            xmx = 150, 
            ymn = -39,
            ymx = -34,
            res = 0.4, 
            crs = "+proj=longlat +datum=WGS84")

x1[] <- 0

tab1 <- table(cellFromXY(x1, training2017_2))

x1[as.numeric(names(tab1))] <- tab1
```



```{r}
# creating proportions
df1 <- data.frame(coordinates(x1), count = x1[])
df1 <- df1 %>% 
  mutate(prop2017 = count/947)  %>%
  dplyr::select(-count)
```

```{r}
# clustered hotspot data
hotspot2017_2 <- hotspot2017
coordinates(hotspot2017_2) <- c("lon", "lat")

xh_2017 <- raster(xmn = 141,
            xmx = 150, 
            ymn = -39,
            ymx = -34,
            res = 0.4, 
            crs = "+proj=longlat +datum=WGS84")

xh_2017[] <- 0

tabh_2017 <- table(cellFromXY(xh_2017, hotspot2017_2))

xh_2017[as.numeric(names(tabh_2017))] <- tabh_2017
```

```{r}
# creating proportions
dfh_2017 <- data.frame(coordinates(xh_2017), count = xh_2017[])
dfh_2017 <- dfh_2017 %>% 
  mutate(prop_h2017 = count/488)  %>%
  dplyr::select(-count)
```

We also look at the difference between the historical and satellite dataset per grid cell. The two maps below represent the number of fires in 2017-2018 period for historical (left) and satellite (right) data. We also compare the data for 2016-2017 and the insights we got are similar. There are a lot of fires in the historical data centered around CBD, indicating that there are more fires in areas where there are more people. Meanwhile, the satellite data shows that there are so little fires around the city center which might be due to the filtering of firepower. There are a lot of fires in remote areas which are not captured by the historical data, which might be due to these remote fires not being able to be monitored by people directly.  Satellite data, on the other hand, can capture these fires well. 

```{r}
# with clustering
plot(x1)
points(training2017, pch = 20)
```
```{r}
plot(xh_2017)
points(hotspot2017_2, pch = 20)
```

To account for the different number of fires each year, we created proportions of fire for each grid cell, which is calculated by dividing the number of fires in that cell for that year divided by the total fires in the year. The result is that there are some differences in the proportions for some cells as seen from the plot below. Some cells have higher proportions for the hotspot data while some others have higher proportions for historical data. Cells with higher proportions for historical data tend to be those areas closer to the city center in where there are a lot of people. On the other hand, cells with higher hotspot proportions are those areas which are more remote. 

```{r}
#creating scatter plot
df_joined_2017 <- df1 %>%
  left_join(dfh_2017, by = c("x", "y")) %>%
  mutate(diff = prop2017 - prop_h2017,
         id = 1:264) 

df_joined_2017 %>%
  group_by(x, y) %>%
  ggplot(aes(x = prop2017,
             y = prop_h2017,
             label = id)) +
  geom_text() +
  ggtitle("Proportions of hotspot vs historical data for 2017-2018")  +
  ylab("Proportions of hotspot data") +
  xlab("Proportions of historical data")
```

In conclusion, satellite or hotspot data provides a more accurate locations and time of bushfire ignitions as satellite data captures those fires in remote areas not visually accessible by people. There was a big fire in Terang on St Patrick’s Day, 17 March 2018. It destroyed residential properties and damaged farming properties. However, this fire was not recorded in the historical data. For these reasons, we decided to use satellite data for our fire risk modelling. 

# Modelling
The most common choice for bushfire risk modelling is the generalised additive model (GAM), which is used by Bates, McCaw, and Dowdy (2018) to predict the number of lightning ignitions in Western Australia. Simpler parametric models have also been used to predict the risk of bushfire, including multiple linear regression and generalized logistic regression.  The predictors used for these models are environmental variables like weather variables and vegetation types. *However, none of the models use hotspot data to predict the risk of bushfire. *? 
We use models like linear regression model, random forest, and lasso regression model to predict the risk of bushfire in Victoria by using the hotspot data. Firstly, we fit a simple linear model to obtain a general insight of the data. We use all variables in the final dataset, which have been explained before, as our predictors. These variables are chosen based on our research about past bushfire risk modelling. This model provides some interesting insights with some predictors being not significant for the model. Average rainfall for that month has a positive correlation with the number of fires while average rainfall for the two months and three months have a negative correlation with the number of fires. Similar thing with maximum temperature, where average maximum temperature for the month and for the two months have a positive relationship with fire counts while average maximum temperature in three months has a negative relationship. This might be due to the non-linear relationship between environmental variables and fire counts. By fitting a linear model, we are assuming that the relationship between the predictors and the response is linear, when in reality it is not. As expected, the linear model has an adjusted R-squared of 0.1452. This indicates that only 14.52% variations in the data are explained by the model, thus a linear regression is not a good model for predicting the risk of bushfire. 
Random forest (Breiman, 2001) is a supervised learning technique that is constructing hundreds of regression trees by using ensemble learning, combined to a robust prediction model. It consists of a large number of decision trees, which are combined by taking the mean of the predicted y values as the prediction of all trees. A random forest model is built from a bootstrap sample of the data. Each tree at each parent node is constructed from p randomly selected predictors (https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0229509). The trees run in parallel without any interactions amongst them (https://levelup.gitconnected.com/random-forest-regression-209c0f354c84). Random forest is well suited for non-linear relationships, which is suitable for our case as the relationship between environmental variables and the fire risk is non-linear. 
An issue with modelling the risk of bushfire based on environmental variable is the collinearity between variables. For example, relative humidity changes when temperature changes. Random forest model can handle multicollinearity problem well as it offers protection against the impact of collinearity between predictors (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4710485/)/. Even though multicollinearity is not a problem for the random forest algorithm itself, it might be a problem for the variable importance. Feature importance might be affected by multicollinearity as the importance of variables with high collinearity will be offset by each other. 
Based on our previous analysis, month is an important variable in determining the risk of fire as the risk of bushfire differs monthly. We use month as a factor variable in our model. The number of variables randomly sampled at each split (mtry) is chosen by using the caret package (citation). The random forest model fitted with 

-- not yet finished, need to finalise our model:
 1. log scale or not
 2. do we include all variables? 
 3. build a separate RF model for each cell id?
 
 # Limitations
 - Random forest overfits & not interpretable
 - 
 
 # Conclusion
 
 # References
 
