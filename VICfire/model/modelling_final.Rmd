---
title: "modelling_final"
author: "Helen Evangelina"
date: "03/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(randomForest)
library(lime)
library(GGally)
library(raster)
library(tmap)
library(tidymodels)
```

```{r}
# --- load relevant variables 
load(here::here("VICfire/data/eda_report.Rdata"))
load(here::here("VICfire/data/ida_report.Rdata"))
```

```{r}
# creating a raster for victoria
vic_raster <- raster(
  # no. of rows & columns (directly linked to resolution of grid cell)
  nrows = 20,
  ncols = 20,
  
  # bbox (bounding box of Victoria)
  xmn = 140.9617,
  xmx = 149.9763,
  ymn = -39.13396,
  ymx = -33.99605,
  
  # crs
  crs = "+proj=longlat +datum=WGS84"
  )
vic_raster[] <- 1:ncell(vic_raster)

# creating the lon & lat for each cell id
lonlat <- as.data.frame(coordinates(vic_raster)) %>%
  mutate(id = as.factor(1:400))
```

## modeling
### simple linear model
```{r}
# using count as the response
lm <- lm(fire_count ~ .-id - year, data = train)
summary(lm)
```

```{r}
# using log scale of count as the response
lm_log <- lm(log(fire_count+1) ~ .-id - year, data = train)
summary(lm_log)
```

### checking if the variables are linear
```{r}
train %>%
  ggplot(aes(y = fire_count,
             x = daily_rain)) +
  geom_jitter() +
  geom_smooth()
```
```{r}
train %>%
  ggplot(aes(y = fire_count,
             x = rh)) +
  geom_jitter() +
  geom_smooth()
```

```{r}
train %>%
  ggplot(aes(y = fire_count,
             x = max_temp)) +
  geom_jitter() +
  geom_smooth()
```

```{r}
train %>%
  ggplot(aes(y = fire_count,
             x = radiation)) +
  geom_jitter() +
  geom_smooth()
```
```{r}
train %>%
  ggplot(aes(y = fire_count,
             x = lai_hv)) +
  geom_jitter() +
  geom_smooth()
```

### glm 
```{r}
glm <- glm(fire_count ~ . -id -year, data = train, family = poisson())
summary(glm)
```
- comparing with normal lm model:
```{r}
lm2 <- glm(fire_count ~ . -id -year, data = train, family = "gaussian")
summary(lm2)
```

both models have high deviance which indicates that the two models are not really a good model. But lm has way higher deviance, which means glm is better?


- plotting the model:
```{r}
library(broom)
augment_lm <- augment(lm2)
ggplot(lm2, aes(x = .fitted,
             y = .resid)) + 
  geom_point() +
  geom_smooth()

augment_glm <- augment(glm)
ggplot(augment_glm, aes(x = .fitted,
             y = .resid)) + 
  geom_point() +
  geom_smooth()
```

### Random Forest 
RF does not work with NAs. With NAs, rf will omit the NAs or impute the values. imputing the values wont work in this case. 
```{r}
train2 <- train %>% 
  ungroup() %>%
  dplyr::select(-id, -year) %>% 
  mutate(month = factor(month, levels = c(10,11,12,1,2,3)))

set.seed(2021)
rfmodel1 <- randomForest(fire_count ~ ., data = train2, importance = TRUE) 
rfmodel1
```
MSR: 2.18886
var exp: 38.18

# correlation between variables
```{r}
data2 <- train %>%
  ungroup() %>%
  dplyr::select(-id, -year) 
ggcorr(data2, label = T)
```
 a lot of variables are highly correlated.
 
```{r}
test2 <- test %>%
  dplyr::select(-id, -year) %>%
  mutate(month = as.factor(month))

predicted <- predict(rfmodel1, test2, type = "response")

# Function for evaluating model
model_summary <- function(truth, estimate){
  
  df_new <- data.frame(truth = truth,
                       estimate = estimate)
  
  data.frame(RMSE = rmse_vec(truth, estimate),
             MAE = mae_vec(truth, estimate),
             "R-Square" = rsq_vec(truth, estimate),
             check.names = F
             ) %>% 
    mutate(MSE = sqrt(RMSE))
}

model_summary(truth = test2$fire_count,
           estimate = predicted)
```
 R-squared of 0.25

```{r}
# if we are using the training 
train3 <- train2 %>% dplyr::select(-fire_count)

# predicting
predicted_train <- predict(rfmodel1, train3, type = "response")

model_summary(truth = train2$fire_count,
           estimate = predicted_train)
```
 R-squared of 0.93


```{r}
set.seed(2021)

explainer <- lime(x = train3,
                  model = rfmodel1) 

# dealing with model_type error
model_type.randomForest <- function(x){
  return("regression") # for regression problem
}

predict_model.randomForest <- function(x, newdata, type = "response") {

    # return prediction value
    predict(x, newdata) %>% as.data.frame()
    
}

# sampling data
data_low <- train2 %>% filter(fire_count < 5)
data_high <- train2 %>% filter(fire_count>5)

set.seed(2021)
lime_sample1 <- sample(1:length(data_low),4)
lime_sample2 <- sample(1:length(data_high),4)

data_selected1 <- data_low[lime_sample1, ]
data_selected2 <- data_high[lime_sample2, ]
data_selected <- data_selected1 %>% bind_rows(data_selected2) %>%
  dplyr::select(-fire_count)

# creating explanation
explanation <- explain(x = data_selected,
                       explainer = explainer, 
                       feature_select = "auto",
                       n_features = 15)

explanation1 <- explanation %>% filter(case %in% c(1,2,3,4)) 
explanation2 <- explanation %>% filter(case %in% c(5,6,7,8)) 
```

```{r}
plot_features(explanation1)
```
important: max_temp, month, si10, radiation, lai_hv_1, s0_pct, et_short_crop, max_temp_2, daily_rain, lai_hv, s0_pct_1, si10_1, daily_rain_1, si10_2, rh, si10_2, radaition_2, forest

```{r}
plot_features(explanation2)
```
add et_short_crop_2, daily_rain_2, 

## fitting model based on these important variables
```{r}
set.seed(2021)
rfmodel2 <- randomForest(fire_count ~ max_temp + month + si10 + radiation + lai_hv_1 + s0_pct + et_short_crop + max_temp_2 + daily_rain + lai_hv + s0_pct_1 + si10_1 + daily_rain_1 + si10_2 + rh + si10_2 + radiation_2 + forest + et_short_crop_2 +daily_rain_2, data = train2, importance = TRUE) 
rfmodel2
```

with all predictors;

          Mean of squared residuals: 2.18886
                    % Var explained: 38.18
                    

conclusion: model with all predictors is better.

# parameter tuning

```{r}
plot(rfmodel1)
```
Error rate stabilises around 100 trees but keep decreasing slowly until around 300 trees. 

```{r}
which.min(rfmodel1$mse)
```
447 gives the lowest MSE.

```{r}
x <- train2 %>% dplyr::select(-fire_count)

set.seed(2021)
mtry <- tuneRF(x, train2$fire_count, ntreeTry=447,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]
print(mtry)
print(best.m)
```
9 gives the lowest error - 2.188197

```{r}
set.seed(2021)
rfmodel3 <- randomForest(fire_count ~ ., data = train2, ntree = 447, mtry = 9, importance = TRUE) 
rfmodel3
```

a bit better!

## Using one rf model for all cell id
- oct 
```{r}
pred <- tibble(rfmodel1$predicted)
data_pred <- train %>% 
  bind_cols(pred) 

mean_data <- data_pred %>%
  group_by(id, month) %>%
  summarise(pred_count = mean(`rfmodel1$predicted`),
            count = mean(fire_count))

mean_oct <- mean_data %>% filter(month == 10) %>%
 left_join(lonlat)

mean_oct <- mean_oct %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_oct) = c("x", "y")
mean_oct_raster <- rasterFromXYZ(mean_oct)

pred_oct <- tm_shape(mean_oct_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "October")

# actual data
dataframe <- data.frame(id = as.factor(1:400)) 

oct_data <- train %>%
  filter(month == 10) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

oct_data <- dataframe %>%
  left_join(oct_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

oct_data <- oct_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(oct_data) = c("x", "y")
oct_raster_actual <- rasterFromXYZ(oct_data)

actual_oct <- tm_shape(oct_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

- nov
```{r}
mean_nov <- mean_data %>% filter(month == 11) %>%
 left_join(lonlat)
mean_nov <- mean_nov %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_nov) = c("x", "y")
mean_nov_raster <- rasterFromXYZ(mean_nov)

pred_nov <- tm_shape(mean_nov_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "November")

# actual data
nov_data <- train %>%
  filter(month == 11) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

nov_data <- dataframe %>%
  left_join(nov_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

nov_data <- nov_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(nov_data) = c("x", "y")
nov_raster_actual <- rasterFromXYZ(nov_data)

actual_nov <- tm_shape(nov_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

- dec
```{r}
mean_dec <- mean_data %>% filter(month == 12) %>%
 left_join(lonlat)
mean_dec <- mean_dec %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_dec) = c("x", "y")
mean_dec_raster <- rasterFromXYZ(mean_dec)

pred_dec <- tm_shape(mean_dec_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "December")

# actual data
dec_data <- train %>%
  filter(month == 12) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

dec_data <- dataframe %>%
  left_join(dec_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

dec_data <- dec_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(dec_data) = c("x", "y")
dec_raster_actual <- rasterFromXYZ(dec_data)

actual_dec <- tm_shape(dec_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

- jan
```{r}
mean_jan <- mean_data %>% filter(month == 1) %>%
 left_join(lonlat)
mean_jan <- mean_jan %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_jan) = c("x", "y")
mean_jan_raster <- rasterFromXYZ(mean_jan)

pred_jan <- tm_shape(mean_jan_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "January")

# actual data
jan_data <- train %>%
  filter(month == 1) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

jan_data <- dataframe %>%
  left_join(jan_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

jan_data <- jan_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(jan_data) = c("x", "y")
jan_raster_actual <- rasterFromXYZ(jan_data)

actual_jan <- tm_shape(jan_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

- feb
```{r}
mean_feb <- mean_data %>% filter(month == 2) %>%
 left_join(lonlat)
mean_feb <- mean_feb %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_feb) = c("x", "y")
mean_feb_raster <- rasterFromXYZ(mean_feb)

pred_feb <- tm_shape(mean_feb_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "February")

# actual data
feb_data <- train %>%
  filter(month == 2) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

feb_data <- dataframe %>%
  left_join(feb_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

feb_data <- feb_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(feb_data) = c("x", "y")
feb_raster_actual <- rasterFromXYZ(feb_data)

actual_feb <- tm_shape(feb_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

- mar
```{r}
mean_mar <- mean_data %>% filter(month == 3) %>%
 left_join(lonlat)
mean_mar <- mean_mar %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_mar) = c("x", "y")
mean_mar_raster <- rasterFromXYZ(mean_mar)

pred_mar <- tm_shape(mean_mar_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "March")

# actual data
mar_data <- train %>%
  filter(month == 3) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

mar_data <- dataframe %>%
  left_join(mar_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

mar_data <- mar_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(mar_data) = c("x", "y")
mar_raster_actual <- rasterFromXYZ(mar_data)

actual_mar <- tm_shape(mar_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

- arranging in one plot
```{r, warning = FALSE, message = FALSE}
tmap_arrange(pred_oct, actual_oct,
             pred_nov, actual_nov,
             pred_dec, actual_dec,
             pred_jan, actual_jan,
             pred_feb, actual_feb,
             pred_mar, actual_mar)
```

- comparison for pred and actual values
```{r}
ggplot(data_pred, aes(x = fire_count, 
                      y = rfmodel1$predicted)) +
  geom_point() +
  ylab("Predicted") +
  xlab("Actual")
```

```{r}
# calculating MSE
mean((data_pred$fire_count - data_pred$`rfmodel1$predicted`)^2)
```
MSE: 2.18886


## RF model for each cell id
```{r}
no_of_id <- unique(train$id)

# making predictions
# without log scale
set.seed(2021)
pred_values <- vector()
for (i in 1:length(no_of_id)) {
  data <- train %>% dplyr::select(-year) %>% filter(id == no_of_id[i])
  rfmodel <-  randomForest(fire_count ~ .-id, data = data, importance = TRUE, mtry = 9, ntree = 447) 
  predicted_values <- rfmodel$predicted 
  for (j in 1:length(predicted_values)) {
  pred_values <- append(pred_values, predicted_values[j])
  }
}
pred_count <- as.data.frame(pred_values) 
final_data <- train %>%
  bind_cols(pred_count)
         
comparison <- final_data %>% 
  dplyr::select(id, month, pred_values, fire_count)

# calculating MSE
mean((comparison$fire_count - comparison$pred_values)^2)

# creating scatter plot
ggplot(comparison, aes(x = fire_count,
                       y = pred_values)) +
  geom_point()
```
### October
```{r}
pred_oct_final <- final_data %>% 
  dplyr::filter(month == 10) %>%
  group_by(id) %>%
  summarise(pred_risk = mean(pred_values))

data_oct_final <- dataframe %>%
  left_join(pred_oct_final) %>%
  dplyr::select(id, pred_risk) %>%
  mutate_all(~replace(., is.na(.), 0)) 

data_oct_final <- data_oct_final %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(data_oct_final) = c("x", "y")
oct_raster <- rasterFromXYZ(data_oct_final)

oct_pred2 <- tm_shape(oct_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "October")

# actual data
oct_data <- final_data %>%
  filter(month == 10) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

oct_data <- dataframe %>%
  left_join(oct_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

oct_data <- oct_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(oct_data) = c("x", "y")
oct_raster_actual <- rasterFromXYZ(oct_data)

oct_actual2 <- tm_shape(oct_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

### November
```{r}
pred_nov_final <-final_data %>% 
  dplyr::filter(month == 11) %>%
  group_by(id) %>%
  summarise(pred_risk = mean(pred_values))

data_nov_final <- dataframe %>%
  left_join(pred_nov_final) %>%
  dplyr::select(id,pred_risk) %>%
  mutate_all(~replace(., is.na(.), 0))

data_nov_final <- data_nov_final %>% left_join(lonlat) %>% 
   dplyr::select(-id)

coordinates(data_nov_final) = c("x", "y")
nov_raster <- rasterFromXYZ(data_nov_final)

nov_pred2 <- tm_shape(nov_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "November")

# actual data
nov_data <- final_data %>%
  filter(month == 11) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

nov_data <- dataframe %>%
  left_join(nov_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

nov_data <- nov_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(nov_data) = c("x", "y")
nov_raster_actual <- rasterFromXYZ(nov_data)

nov_actual2 <- tm_shape(nov_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

### decmeber
```{r}
pred_dec_final <- final_data %>% 
  dplyr::filter(month == 12) %>%
  group_by(id) %>%
  summarise(pred_risk = mean(pred_values))

data_dec_final <- dataframe %>%
  left_join(pred_dec_final) %>%
  dplyr::select(id, pred_risk) %>%
  mutate_all(~replace(., is.na(.), 0))

data_dec_final <- data_dec_final %>% left_join(lonlat) %>% 
   dplyr::select(-id)

coordinates(data_dec_final) = c("x", "y")
dec_raster <- rasterFromXYZ(data_dec_final)

dec_pred2 <- tm_shape(dec_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title="December")

# actual data
dec_data <- final_data %>%
  filter(month == 12) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

dec_data <- dataframe %>%
  left_join(dec_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

dec_data <- dec_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(dec_data) = c("x", "y")
dec_raster_actual <- rasterFromXYZ(dec_data)

dec_actual2 <- tm_shape(dec_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

### january
```{r}
pred_jan_final <- final_data %>% 
  dplyr::filter(month == 1) %>%
  group_by(id) %>%
  summarise(pred_risk = mean(pred_values))

data_jan_final <- dataframe %>%
  left_join(pred_jan_final) %>%
  dplyr::select(id, pred_risk) %>%
  mutate_all(~replace(., is.na(.), 0))

data_jan_final <- data_jan_final %>% left_join(lonlat) %>% 
   dplyr::select(-id)

coordinates(data_jan_final) = c("x", "y")
jan_raster <- rasterFromXYZ(data_jan_final)

jan_pred2 <- tm_shape(jan_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "January")

# actual data
jan_data <- final_data %>%
  filter(month == 1) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

jan_data <- dataframe %>%
  left_join(jan_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

jan_data <- jan_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(jan_data) = c("x", "y")
jan_raster_actual <- rasterFromXYZ(jan_data)

jan_actual2 <- tm_shape(jan_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

### february
```{r}
pred_feb_final <- final_data %>% 
  dplyr::filter(month == 2) %>%
  group_by(id) %>%
  summarise(pred_risk = mean(pred_values))

data_feb_final <- dataframe %>%
  left_join(pred_feb_final) %>%
  dplyr::select(id, pred_risk) %>%
  mutate_all(~replace(., is.na(.), 0))

data_feb_final <- data_feb_final %>% left_join(lonlat) %>% 
   dplyr::select(-id)

coordinates(data_feb_final) = c("x", "y")
feb_raster <- rasterFromXYZ(data_feb_final)

feb_pred2 <- tm_shape(feb_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "February") 

#actual data
feb_data <- final_data %>%
  filter(month ==2) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

feb_data <- dataframe %>%
  left_join(feb_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

feb_data <- feb_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(feb_data) = c("x", "y")
feb_raster_actual <- rasterFromXYZ(feb_data)

feb_actual2 <- tm_shape(feb_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

### march 
```{r}
pred_mar_final <- final_data %>% 
  dplyr::filter(month == 3) %>%
  group_by(id) %>%
  summarise(pred_risk = mean(pred_values))

data_mar_final <- dataframe %>%
  left_join(pred_mar_final) %>%
  dplyr::select(id, pred_risk) %>%
  mutate_all(~replace(., is.na(.), 0))

data_mar_final <- data_mar_final %>% left_join(lonlat) %>% 
   dplyr::select(-id)

coordinates(data_mar_final) = c("x", "y")
mar_raster <- rasterFromXYZ(data_mar_final)

mar_pred2 <- tm_shape(mar_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "March",
            legend.position = c("right", "top"))

# actual data
mar_data <- final_data %>%
  filter(month == 3) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

mar_data <- dataframe %>%
  left_join(mar_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

mar_data <- mar_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(mar_data) = c("x", "y")
mar_raster_actual <- rasterFromXYZ(mar_data)

mar_actual2 <- tm_shape(mar_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) 
```

- arranging in one plot
```{r, warning = FALSE, message = FALSE}
tmap_arrange(oct_pred2, oct_actual2,
             nov_pred2, nov_actual2,
             dec_pred2, dec_actual2,
             jan_pred2, jan_actual2,
             feb_pred2, feb_actual2,
             mar_pred2, mar_actual2)
```

```{r}

rfmodel <- function(data){
  set.seed(2021)
  
  no_of_id <- unique(data$id)
  
  pred_values <- vector()
  for (i in 1:length(no_of_id)) {
    data2 <- data %>% filter(id == no_of_id[i]) %>% mutate(month = as.factor(month))
    rfmodel <-  randomForest(fire_count ~ .-id, data = data2, importance = TRUE, mtry = 9, ntree = 447) 
    predicted_values <- rfmodel$predicted 
    for (j in 1:length(predicted_values)) {
    pred_values <- append(pred_values, predicted_values[j])
    }
  }
  pred_count <- as.data.frame(pred_values) 
  final_data <- data %>% bind_cols(pred_count)
  
  final_data
}
  
rfmodel(train)

```


kita mau for each id in the test data, kita match ke id in the training data --> using the data with the same id in the training, we fit a model --> put it in a model object called rf --> and then use it to predict the values 

```{r}
train4 <- train %>% dplyr::select(-year)

# predict function
predicting <- function(train_data, test_data) {
  no_of_id2 <- unique(test_data$id)
  
  no_of_id <- unique(train_data$id)
  
  final_predicted <- c()
  for (i in 1:length(no_of_id2)) {
    
   data2 <- train_data %>% filter(id == no_of_id[i]) %>% mutate(month = as.factor(month))
   
   test_data2 <- test_data %>% filter(id == no_of_id[i])
   
   rfmodel <-  randomForest(fire_count ~ .-id, data = data2, importance = TRUE, mtry = 9, ntree = 447) 
   
   predicted_values <- predict(rfmodel, test_data2)
   
   pred_data <- test_data2 %>% mutate(pred = predicted_values)
   
   final_predicted <- final_predicted %>% bind_rows(pred_data)
  }
  
  final_predicted
}

predicted_test <- predicting(train4, test2)
```


```{r}
# predicting
predicted2 <- predicted_test$pred

model_summary(truth = predicted_test$fire_count,
           estimate = predicted2)
```

it's better for the test set?

general rf tends to underpredicting.
individual rf tends to overpredicting.

```{r}
model_summary(truth = comparison$fire_count, 
              estimate = comparison$pred_values)
```



```{r}
data_171 <- train %>% filter(id == 171)
 rfmodel171 <-  randomForest(fire_count ~ .-id, data = data_171, importance = TRUE, mtry = 9, ntree = 447) 
a <- rfmodel171$predicted
```

```{r}
set.seed(2021)
mse_values <- vector()
for (i in 1:length(no_of_id)) {
  data <- train %>% dplyr::select(-year) %>% filter(id == no_of_id[i])
  rfmodel <-  randomForest(fire_count ~ .-id, data = data, importance = TRUE, mtry = 9, ntree = 447) 
  mse <-  rfmodel$mse
  mse_values[i] <- mse
}
mse <- tibble(mse_values)
```
## including lon and lat in the model
```{r}
train_final <- train %>% 
  left_join(lonlat, by = "id") %>%
  dplyr::select(-year)

set.seed(2021)
rfmodel4 <- randomForest(fire_count ~ .-id, data = train_final, ntree = 500, mtry = 9, importance = TRUE) 
rfmodel4
```
 
```{r}
set.seed(2021)
rfmodel5 <- randomForest(fire_count ~ .-id, data = train_final, importance = TRUE) 
rfmodel5
```
 

## parameters tuning
# parameter tuning

```{r}
plot(rfmodel4)
```
Error rate stabilises around 100 trees but keep decreasing slowly until around 300 trees. 

```{r}
which.min(rfmodel4$mse)
```



```{r}
x <- train_final %>% ungroup() %>% dplyr::select(-fire_count, -id)

set.seed(2021)
mtry <- tuneRF(x, train_final$fire_count, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]
print(mtry)
print(best.m)
```


```{r}
predicted_test_data <- tibble(pred = predicted2) %>%
  bind_cols(test2)
test_oct <- test2 %>% filter(month == 10) %>%
 left_join(lonlat) %>%
  ungroup() %>%
  dplyr::select(x,y,fire_count)
coordinates(test_oct) = c("x", "y")
test_oct_raster <- rasterFromXYZ(test_oct)
test_actual_oct <- tm_shape(test_oct_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "October")
# pred data
test_oct_pred <- predicted_test_data %>%
  filter(month == 10) %>%
  dplyr::select(id,pred) %>%
  left_join(lonlat) %>%
   dplyr::select(-id)
coordinates(test_oct_pred) = c("x", "y")
pred_oct_test_raster <- rasterFromXYZ(test_oct_pred)
test_pred_oct <- tm_shape(pred_oct_test_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
# for nov
test_nov <- test2 %>% filter(month == 11) %>%
 left_join(lonlat) %>%
  ungroup() %>%
  dplyr::select(x,y,fire_count)
coordinates(test_nov) = c("x", "y")
test_nov_raster <- rasterFromXYZ(test_nov)
test_actual_nov <- tm_shape(test_nov_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "November")
# pred data
test_nov_pred <- predicted_test_data %>%
  filter(month == 11) %>%
  dplyr::select(id,pred) %>%
  left_join(lonlat) %>%
   dplyr::select(-id)
coordinates(test_nov_pred) = c("x", "y")
pred_nov_test_raster <- rasterFromXYZ(test_nov_pred)
test_pred_nov <- tm_shape(pred_nov_test_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
# for dec
test_dec <- test2 %>% filter(month == 12) %>%
 left_join(lonlat) %>%
  ungroup() %>%
  dplyr::select(x,y,fire_count)
coordinates(test_dec) = c("x", "y")
test_dec_raster <- rasterFromXYZ(test_dec)
test_actual_dec <- tm_shape(test_dec_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "December")
# pred data
test_dec_pred <- predicted_test_data %>%
  filter(month == 12) %>%
  dplyr::select(id,pred) %>%
  left_join(lonlat) %>%
   dplyr::select(-id)
coordinates(test_dec_pred) = c("x", "y")
pred_dec_test_raster <- rasterFromXYZ(test_dec_pred)
test_pred_dec <- tm_shape(pred_dec_test_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
# for jan
test_jan <- test2 %>% filter(month == 1) %>%
 left_join(lonlat) %>%
  ungroup() %>%
  dplyr::select(x,y,fire_count)
coordinates(test_jan) = c("x", "y")
test_jan_raster <- rasterFromXYZ(test_jan)
test_actual_jan <- tm_shape(test_jan_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "January")
# pred data
test_jan_pred <- predicted_test_data %>%
  filter(month == 1) %>%
  dplyr::select(id,pred) %>%
  left_join(lonlat) %>%
   dplyr::select(-id)
coordinates(test_jan_pred) = c("x", "y")
pred_jan_test_raster <- rasterFromXYZ(test_jan_pred)
test_pred_jan <- tm_shape(pred_jan_test_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
# for feb
test_feb <- test2 %>% filter(month ==2) %>%
 left_join(lonlat) %>%
  ungroup() %>%
  dplyr::select(x,y,fire_count)
coordinates(test_feb) = c("x", "y")
test_feb_raster <- rasterFromXYZ(test_feb)
test_actual_feb <- tm_shape(test_feb_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "February")
# pred data
test_feb_pred <- predicted_test_data %>%
  filter(month == 2) %>%
  dplyr::select(id,pred) %>%
  left_join(lonlat) %>%
   dplyr::select(-id)
coordinates(test_feb_pred) = c("x", "y")
pred_feb_test_raster <- rasterFromXYZ(test_feb_pred)
test_pred_feb <- tm_shape(pred_feb_test_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
# for march
test_mar <- test2 %>% filter(month == 3) %>%
 left_join(lonlat) %>%
  ungroup() %>%
  dplyr::select(x,y,fire_count)
coordinates(test_mar) = c("x", "y")
test_mar_raster <- rasterFromXYZ(test_mar)
test_actual_mar <- tm_shape(test_mar_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "March")
# pred data
test_mar_pred <- predicted_test_data %>%
  filter(month == 3) %>%
  dplyr::select(id,pred) %>%
  left_join(lonlat) %>%
   dplyr::select(-id)
coordinates(test_mar_pred) = c("x", "y")
pred_mar_test_raster <- rasterFromXYZ(test_mar_pred)
test_pred_mar <- tm_shape(pred_mar_test_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)
```

```{r map-rf-test2, fig.cap = "A map of the monthly fire counts of the actual vs the predicted values resulted from the cell-specific random forest model for the test set.", warning = FALSE, message = FALSE}
tmap_arrange( test_actual_oct, test_pred_oct,
              test_actual_nov, test_pred_nov,
              test_actual_dec, test_pred_dec,
              test_actual_jan, test_pred_jan,
              test_actual_feb, test_pred_feb,
              test_actual_mar, test_pred_mar)
```

# using the ranger package instead
```{r}
# converting month to factor
train_final <- train_final %>% mutate(month = as.factor(month))
```


```{r}
library(ranger)
set.seed(2021)
ranger(fire_count ~ .-id, data = train_final, importance = "impurity")
```

```{r}
library(tuneRanger)
set.seed(21)
train_final3 <- train_final %>%
  ungroup() %>% 
  dplyr::select(-id)
task <- makeRegrTask(data = train_final3, target = "fire_count")
tuning <- tuneRanger(task, num.trees = 500)

tuning
```

```{r}
tuning$model
```

```{r}
set.seed(2021)
randomforest <- ranger(fire_count ~ .-id, data = train_final, importance = "impurity",num.threads=8,verbose=FALSE,mtry=7,min.node.size=2,sample.fraction=0.859,num.trees=500,replace=FALSE)
randomforest
```

```{r}
varimp <- data.frame(importance =randomforest$variable.importance)
df <- rownames_to_column(varimp, "var")
df
```


```{r}
 ggplot(df, aes(x=reorder(var,importance), y=importance,fill=importance))+ 
      geom_bar(stat="identity", position="dodge")+ coord_flip()+
      ylab("Variable Importance")+
      xlab("")+
      guides(fill=F)
```

```{r}
randomforest1
```



```{r}
predicted_train <- tibble(pred = randomforest$predictions)
train_final2 <- train_final %>%
  bind_cols(predicted_train)


```

wanna create the residuals for each cell id based per month. So instead of what we did beforem, we make it residuals. (observed - fitted) --> create a plot for observed vs fitted as well
```{r}
# for the training set
residual <- train_final2 %>% 
  mutate(residual = fire_count - pred) %>%
  dplyr::select(x, y, month, residual) 

mean_residual <- residual %>%
  group_by(x,y, month) %>%
  summarise(mean_residual = mean(residual))

res_oct <- mean_residual %>% filter(month == 10) %>% dplyr::select(-month)
coordinates(res_oct) = c("x", "y")
res_oct_raster <- rasterFromXYZ(res_oct)
res_oct_plot <- tm_shape(res_oct_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "October")

res_nov <- mean_residual %>% filter(month == 11) %>% dplyr::select(-month)
coordinates(res_nov) = c("x", "y")
res_nov_raster <- rasterFromXYZ(res_nov)
res_nov_plot <- tm_shape(res_nov_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "November")

res_dec <- mean_residual %>% filter(month == 12) %>% dplyr::select(-month)
coordinates(res_dec) = c("x", "y")
res_dec_raster <- rasterFromXYZ(res_dec)
res_dec_plot <- tm_shape(res_dec_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "December")

res_jan <- mean_residual %>% filter(month == 1) %>% dplyr::select(-month)
coordinates(res_jan) = c("x", "y")
res_jan_raster <- rasterFromXYZ(res_jan)
res_jan_plot <- tm_shape(res_jan_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "January")

res_feb <- mean_residual %>% filter(month == 2) %>% dplyr::select(-month)
coordinates(res_feb) = c("x", "y")
res_feb_raster <- rasterFromXYZ(res_feb)
res_feb_plot <- tm_shape(res_feb_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "February")

res_mar <- mean_residual %>% filter(month == 3) %>% dplyr::select(-month)
coordinates(res_mar) = c("x", "y")
res_mar_raster <- rasterFromXYZ(res_mar)
res_mar_plot <- tm_shape(res_mar_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "March")

```

```{r, message=FALSE, warning = FALSE}
tmap_arrange(res_oct_plot, res_nov_plot, res_dec_plot, res_jan_plot, res_feb_plot, res_mar_plot)
```

```{r}
# MSE of training set
mean(residual$residual^2)
```


```{r}
test_final <- test %>%
  left_join(lonlat, by = "id") %>%
  dplyr::select(-year)
predicted_test <- test_final %>% bind_cols(tibble(pred = predict(randomforest, test_final)$predictions))

residual_test <- predicted_test %>% 
  mutate(residual = fire_count - pred) %>%
  ungroup() %>%
  dplyr::select(x,y,residual, month)

res_test_oct <- residual_test %>% filter(month == 10) %>% dplyr::select(-month)
coordinates(res_test_oct) = c("x", "y")
res_test_oct_raster <- rasterFromXYZ(res_test_oct)
res_test_oct_plot <- tm_shape(res_test_oct_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "October")

res_test_nov <- residual_test %>% filter(month == 11) %>% dplyr::select(-month)
coordinates(res_test_nov) = c("x", "y")
res_test_nov_raster <- rasterFromXYZ(res_test_nov)
res_test_nov_plot <- tm_shape(res_test_nov_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "November")

res_test_dec <- residual_test %>% filter(month == 12) %>% dplyr::select(-month)
coordinates(res_test_dec) = c("x", "y")
res_test_dec_raster <- rasterFromXYZ(res_test_dec)
res_test_dec_plot <- tm_shape(res_dec_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "December")

res_test_jan <- residual_test %>% filter(month == 1) %>% dplyr::select(-month)
coordinates(res_test_jan) = c("x", "y")
res_test_jan_raster <- rasterFromXYZ(res_test_jan)
res_test_jan_plot <- tm_shape(res_test_jan_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "January")

res_test_feb <- residual_test %>% filter(month == 2) %>% dplyr::select(-month)
coordinates(res_test_feb) = c("x", "y")
res_test_feb_raster <- rasterFromXYZ(res_test_feb)
res_test_feb_plot <- tm_shape(res_test_feb_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "February")

res_test_mar <- residual_test %>% filter(month == 3) %>% dplyr::select(-month)
coordinates(res_test_mar) = c("x", "y")
res_test_mar_raster <- rasterFromXYZ(res_test_mar)
res_test_mar_plot <- tm_shape(res_test_mar_raster) +
  tm_raster(style = "cont", 
            palette = "RdYlGn",
                  alpha = 0.4) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "March")

```

```{r, message=FALSE, warning = FALSE}
tmap_arrange(res_test_oct_plot, res_test_nov_plot, res_test_dec_plot, res_test_jan_plot, res_test_feb_plot, res_test_mar_plot)
```

```{r}
# MSE of test set
mean(residual_test$residual^2)
```

```{r}
ggplot(predicted_test, aes(x = pred,
                           y = fire_count)) +
  geom_point()
```

-- so much differences? -- 

## see how much risk would change if we change the variables
- cell 237
```{r}
test_237 <- test2 %>%
  filter(id == 237) 

test_237 <- test_237 %>%
  bind_cols(pred = predict(randomforest, test_237)$predictions)

for (i in 1:10) {
  temp <- test_237
  temp$max_temp <- temp$max_temp + i
  test_237 <- test_237 %>% bind_cols(new_pred = predict(randomforest, temp)$predictions)
}
test_237_2 <- test_237 %>%
  ungroup() %>%
  rename("0" = pred, 
         "+1" = `new_pred...35`,
         "+2" = `new_pred...36`,
         "+3" = new_pred...37,
         "+4" = new_pred...38,
         "+5" = new_pred...39,
         "+6" = new_pred...40, 
         "+7" = new_pred...41,
         "+8" = new_pred...42,
         "+9" = new_pred...43,
         "+10" = new_pred...44)
  
test_237_2 <- test_237_2 %>% dplyr::select(month, `0`:`+10`) %>% pivot_longer(2:12, names_to = "Increase_by", values_to = "new_pred" ) %>%
  mutate(month = factor(month, levels = c(10,11,12,1,2,3)))

ggplot(test_237_2, aes(x = Increase_by, 
                       y = new_pred)) +
  geom_point() +
  facet_grid(~month)
```

- cell 275
```{r}
test_275 <- test2 %>%
  filter(id == 275) 
test_275 <- test_275%>%
  bind_cols(pred = predict(randomforest, test_275)$predictions)

for (i in 1:10) {
  temp <- test_275
  temp$max_temp <- temp$max_temp + i
  test_275 <- test_275 %>% bind_cols(new_pred = predict(randomforest, temp)$predictions)
}
test_275_2 <- test_275 %>%
  ungroup() %>%
  rename("0" = pred, 
         "+1" = `new_pred...35`,
         "+2" = `new_pred...36`,
         "+3" = new_pred...37,
         "+4" = new_pred...38,
         "+5" = new_pred...39,
         "+6" = new_pred...40, 
         "+7" = new_pred...41,
         "+8" = new_pred...42,
         "+9" = new_pred...43,
         "+10" = new_pred...44)
  
test_275_2 <- test_275_2 %>% dplyr::select(month, `0`:`+10`) %>% pivot_longer(2:12, names_to = "Increase_by", values_to = "new_pred" ) %>%
  mutate(month = factor(month, levels = c(10,11,12,1,2,3)))

ggplot(test_275_2, aes(x = Increase_by, 
                       y = new_pred)) +
  geom_point() +
  facet_grid(~month)
```

- cell 172
```{r}
test_172 <- test2 %>%
  filter(id == 172) 
test_172 <- test_172 %>%
  bind_cols(pred = predict(randomforest, test_172)$predictions)

for (i in  1:10) {
  temp <- test_172
  temp$max_temp <- temp$max_temp + i
  test_172 <- test_172 %>% bind_cols(new_pred = predict(randomforest, temp)$predictions)
}
test_172_2 <- test_172 %>%
  ungroup() %>%
  rename("0" = pred, 
         "+1" = `new_pred...35`,
         "+2" = `new_pred...36`,
         "+3" = new_pred...37,
         "+4" = new_pred...38,
         "+5" = new_pred...39,
         "+6" = new_pred...40, 
         "+7" = new_pred...41,
         "+8" = new_pred...42,
         "+9" = new_pred...43,
         "+10" = new_pred...44)
  
test_172_2 <- test_172_2 %>% dplyr::select(month, `0`:`+10`) %>% pivot_longer(2:12, names_to = "Increase_by", values_to = "new_pred" ) %>%
  mutate(month = factor(month, levels = c(10,11,12,1,2,3)))

ggplot(test_172_2, aes(x = Increase_by, 
                       y = new_pred)) +
  geom_point() +
  facet_grid(~month)

test_172
```

# for radiation
- cell 237
```{r}
test_237 <- test2 %>%
  filter(id == 237) 
test_237_rad <- test_237 %>%
  bind_cols(pred = predict(randomforest, test_237)$predictions)

for (i in 1:10) {
  temp <- test_237
  temp$radiation <- temp$radiation + i
  test_237_rad <- test_237_rad %>% bind_cols(new_pred = predict(randomforest, temp)$predictions)
}
test_237_2rad <- test_237_rad %>%
  ungroup() %>%
  rename("0" = pred, 
         "+1" = `new_pred...35`,
         "+2" = `new_pred...36`,
         "+3" = new_pred...37,
         "+4" = new_pred...38,
         "+5" = new_pred...39,
         "+6" = new_pred...40, 
         "+7" = new_pred...41,
         "+8" = new_pred...42,
         "+9" = new_pred...43,
         "+10" = new_pred...44)
  
test_237_2rad <- test_237_2rad %>% dplyr::select(month, `0`:`+10`) %>% pivot_longer(2:12, names_to = "Increase_by", values_to = "new_pred" ) %>%
  mutate(month = factor(month, levels = c(10,11,12,1,2,3)))

ggplot(test_237_2rad, aes(x = Increase_by, 
                       y = new_pred)) +
  geom_point() +
  facet_grid(~month)
```

```{r}
rf2_data <- train_final %>% bind_cols(pred = randomforest1$predictions) %>% 
  mutate(resid = fire_count - pred)

mean_data <- rf2_data %>%
  group_by(id, month) %>%
  summarise(pred_count = mean(pred),
            count = mean(fire_count))

mean_oct <- mean_data %>% filter(month == 10) %>%
 left_join(lonlat)

mean_oct <- mean_oct %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_oct) = c("x", "y")
mean_oct_raster <- rasterFromXYZ(mean_oct)

pred_oct <- tm_shape(mean_oct_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "October") +
  tm_legend(show = FALSE)

# actual data
dataframe <- data.frame(id = as.factor(1:400)) 

oct_data <- train %>%
  filter(month == 10) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

oct_data <- dataframe %>%
  left_join(oct_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

oct_data <- oct_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(oct_data) = c("x", "y")
oct_raster_actual <- rasterFromXYZ(oct_data)

actual_oct <- tm_shape(oct_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_legend(show = FALSE)

mean_nov <- mean_data %>% filter(month == 11) %>%
 left_join(lonlat)
mean_nov <- mean_nov %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_nov) = c("x", "y")
mean_nov_raster <- rasterFromXYZ(mean_nov)

pred_nov <- tm_shape(mean_nov_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "November") +
  tm_legend(show = FALSE)

# actual data
nov_data <- train %>%
  filter(month == 11) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

nov_data <- dataframe %>%
  left_join(nov_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

nov_data <- nov_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(nov_data) = c("x", "y")
nov_raster_actual <- rasterFromXYZ(nov_data)

actual_nov <- tm_shape(nov_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_legend(show = FALSE)

mean_dec <- mean_data %>% filter(month == 12) %>%
 left_join(lonlat)
mean_dec <- mean_dec %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_dec) = c("x", "y")
mean_dec_raster <- rasterFromXYZ(mean_dec)

pred_dec <- tm_shape(mean_dec_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "December") +
  tm_legend(show = FALSE)

# actual data
dec_data <- train %>%
  filter(month == 12) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

dec_data <- dataframe %>%
  left_join(dec_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

dec_data <- dec_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(dec_data) = c("x", "y")
dec_raster_actual <- rasterFromXYZ(dec_data)

actual_dec <- tm_shape(dec_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3)+
  tm_legend(show = FALSE)

mean_jan <- mean_data %>% filter(month == 1) %>%
 left_join(lonlat)
mean_jan <- mean_jan %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_jan) = c("x", "y")
mean_jan_raster <- rasterFromXYZ(mean_jan)

pred_jan <- tm_shape(mean_jan_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "January") +
  tm_legend(show = FALSE)

# actual data
jan_data <- train %>%
  filter(month == 1) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

jan_data <- dataframe %>%
  left_join(jan_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

jan_data <- jan_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(jan_data) = c("x", "y")
jan_raster_actual <- rasterFromXYZ(jan_data)

actual_jan <- tm_shape(jan_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_legend(show = FALSE)

mean_feb <- mean_data %>% filter(month == 2) %>%
 left_join(lonlat)
mean_feb <- mean_feb %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_feb) = c("x", "y")
mean_feb_raster <- rasterFromXYZ(mean_feb)

pred_feb <- tm_shape(mean_feb_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "February") +
  tm_legend(show = FALSE)

# actual data
feb_data <- train %>%
  filter(month == 2) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

feb_data <- dataframe %>%
  left_join(feb_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

feb_data <- feb_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(feb_data) = c("x", "y")
feb_raster_actual <- rasterFromXYZ(feb_data)

actual_feb <- tm_shape(feb_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_legend(show = FALSE)

mean_mar <- mean_data %>% filter(month == 3) %>%
 left_join(lonlat)
mean_mar <- mean_mar %>%
  ungroup() %>%
  dplyr::select(-count,-id, -month)

coordinates(mean_mar) = c("x", "y")
mean_mar_raster <- rasterFromXYZ(mean_mar)

pred_mar <- tm_shape(mean_mar_raster) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4,
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(title = "March") + 
  tm_legend(show = FALSE)

# actual data
mar_data <- train %>%
  filter(month == 3) %>%
  group_by(id) %>%
  summarise(count = mean(fire_count))

mar_data <- dataframe %>%
  left_join(mar_data) %>%
  dplyr::select(id,count) %>%
  mutate_all(~replace(., is.na(.), 0))

mar_data <- mar_data %>% left_join(lonlat) %>%
   dplyr::select(-id)

coordinates(mar_data) = c("x", "y")
mar_raster_actual <- rasterFromXYZ(mar_data)

actual_mar <- tm_shape(mar_raster_actual) +
  tm_raster(style = "cont", 
            palette = "seq",
                  alpha = 0.4, 
            breaks = c(0,5,10,15)) +
  tm_shape(vic_map_sf) +
  tmap::tm_borders(lwd = 3) +
  tm_layout(legend.position = c("right","top"))

```

```{r map-rf1, fig.cap = "A map of the monthly fire counts of the actual vs the predicted values resulted from the random forest model for the training set.", warning = FALSE, message = FALSE}
tmap_arrange(pred_oct, actual_oct,
             pred_nov, actual_nov,
             pred_dec, actual_dec,
             pred_jan, actual_jan,
             pred_feb, actual_feb,
             pred_mar, actual_mar)
```